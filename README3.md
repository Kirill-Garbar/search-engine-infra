# otus-devops-project
Чтобы развернуть инфру, нужно:
- Забрать репу
- Создать кластер терраформом из директории /nfra/terraform/stage terraform-apply. Предвариттельно заполнить переменные.
- Далее выполнить команды:
Настроить контекст на кластер кубера

`gcloud container clusters get-credentials standard-cluster-1 --zone europe-west1-b --project docker-223709`

Установить роли для Тиллера

`kubectl apply -f manifests/tiller.yml`

Иницианилизровать Хельм

`helm init --wait --service-account tiller`

Установить ингресс контроллер

`helm install --wait stable/nginx-ingress --name nginx`

Посмотреть его внешний IP и добавлять в хосты нужные имена (search-engine-production, search-engine-staging, search-engine-{branch_name}).

`kubectl get svc`

Перейти в директорию kubernetes. Выполнить команду установки прометея.

`helm upgrade --wait prometheus charts/prometheus --install --recreate-pods`

Выполнить команду установки графаны.

`helm upgrade --wait grafana ./charts/grafana --install`

Выполнить команду установки гитлаба.

`helm upgrade --wait gitlab ./charts/gitlab-omnibus --install`

- Посмотреть под каким IP доступен гитлаб. Добавить в хосты по имени gitlab-gitlab.
- В гитлабе нужно создать пароль, группу kirillgarbar, проекты ui, crawler, deploy.
- В гитлабе создать переменные для логин и пароля к докерхабу, триггер токен. CI_REGISTRY_USER, CI_REGISTRY_PASSWORD, CI_SEARCH_ENGINE_DEPLOY_TOKEN.
- Создать триггер и заполнить его ссылку в файлах .gitlab_ci.yml микросервисов.
- Инициализировать в директориях микросервисов src/и kubernetes/charts гит репы и запушить их в гитлаб. Пройдут первые пайплайны, которые зафейлятся, потому что не все сервисы запушены в докерхаб.

# Что нужно сделать к сдаче проекта:
- **Изменить структуру репы. Придумать как. Вариант сделать отдельно инфра репу с чартами инфры. Отдельно репы приложений. Отдельно чарты для деплоя приложения.**
- **Запуск на DNS зоне.**
- **Отвязать гитлаб от кубера. Сделать интеграцию гитлаба и кубера, чтобы раннеры запускались в подах.**
- **Написать шелл скрипт провижнинга. Ансиблом не получится, потому что нет внятных модулей для хельма.**
- **Автоматическая загрузка чартов в графану из репы.**
- **Расставить теги в ансибле.**
- **Запуск имеющихся тестов.**
- **Параметризовать чарты в отношении изменяющихся пременных (DNS зона).**
- **Отвязать название группы от репы в докерхабе.**
- **Прикрутить gitlab registry.**
- **Сделать красиво доменные имена и https.**
- **Постараться сделать красиво переменные в ансибле в группах. Сейчас all + tag_gitlab-server.**
- **Написать правила fluentd для парсинга логов ui, crawler.**
- **Графана, чарты мониторинга кубера, монги, подов. Чарты мониторинга существующих метрик приложения.**
- **Графана, чарты мониторинга монги и рэббита.**
- Логи для rabbitmq, mongodb
- **Сделать деплойменты из двух подов и проверить как выводятся релизы.**
- **Внятное хранение секретов в кубере.**
- **Заменить названия приложений на ui и crawler. Передавать search-engine (группу), ui и crawler как переменные.**
- **Посмотреть метрики ингресс-контроллера.**
