# otus-devops-project
Чтобы развернуть инфру, нужно:
- Забрать репу
- Создать кластер терраформом из директории /nfra/terraform/stage terraform-apply. Предвариттельно заполнить переменные.
- Далее выполнить команды:
Настроить контекст на кластер кубера

`gcloud container clusters get-credentials standard-cluster-1 --zone europe-west1-b --project docker-223709`

Установить роли для Тиллера

`kubectl apply -f manifests/tiller.yml`

Иницианилизровать Хельм

`helm init --wait --service-account tiller`

Установить ингресс контроллер

`helm install --wait stable/nginx-ingress --name nginx`

Посмотреть его внешний IP и добавлять в хосты нужные имена (search-engine-production, search-engine-staging, search-engine-{branch_name}).

`kubectl get svc`

Перейти в директорию kubernetes. Выполнить команду установки прометея.

`helm upgrade --wait prometheus charts/prometheus --install --recreate-pods`

Выполнить команду установки графаны.

`helm upgrade --wait grafana ./charts/grafana --install`

Выполнить команду установки гитлаба.

`helm upgrade --wait gitlab ./charts/gitlab-omnibus --install`

- Посмотреть под каким IP доступен гитлаб. Добавить в хосты по имени gitlab-gitlab.
- В гитлабе нужно создать пароль, группу kirillgarbar, проекты search-engine-ui, search-engine-crawler, search-engine-deploy.
- В гитлабе создать переменные для логин и пароля к докерхабу, триггер токен. CI_REGISTRY_USER, CI_REGISTRY_PASSWORD, CI_SEARCH_ENGINE_DEPLOY_TOKEN.
- Создать триггер и заполнить его ссылку в файлах .gitlab_ci.yml микросервисов.
- Инициализировать в директориях микросервисов src/и kubernetes/charts гит репы и запушить их в гитлаб. Пройдут первые пайплайны, которые зафейлятся, потому что не все сервисы запушены в докерхаб.

# Что нужно сделать к сдаче проекта:
- Графана, чарты мониторинга кубера, монги, подов. Чарты мониторинга существующих метрик приложения.
- Автоматическая загрузка чартов в графану из репы.
- Запуск на DNS зоне.
- Внятное хранение секретов в кубере.
- Запуск имеющихся тестов.
- Переписать чарт EFK и запустить логгинг.
- Отвязать название группы от репы в докерхабе.
- Изменить структуру репы. Придумать как. Вариант сделать отдельно инфра репу с чартами инфры. Отдельно репы приложений. Отдельно чарты для деплоя приложения.
- Написать Makefile для первоначального билда и пуша образов в докерхаб (опционально).
- Отвязать гитлаб от кубера. Сделать интеграцию гитлаба и кубера, чтобы раннеры запускались в подах. Может быть автоскейлинг.
- Написать шелл скрипт провижнинга. Ансиблом не получится, потому что нет внятных модулей для хельма.
- Возможно развернуть кубер на виртуалках с контроллером.
